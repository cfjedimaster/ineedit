<?xml version="1.0" encoding="utf-8"?>
<s:View xmlns:fx="http://ns.adobe.com/mxml/2009" 
		xmlns:s="library://ns.adobe.com/flex/spark" title="" viewActivate="init(event)">
	
	<fx:Script>
		<![CDATA[
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			import spark.events.ViewNavigatorEvent;
			import com.adobe.serialization.json.JSON;
			import mx.rpc.AsyncToken;
			
			//Bad code Ray - don't repeat!
			private var apiKey:String = "AIzaSyBmTswgqdK5l2WmFk7PdbLl5-E8pJ1XgMM";
			
			private function goBack(event:MouseEvent):void {
				navigator.popView();
			}
			
			protected function init(event:ViewNavigatorEvent):void
			{
				this.title = data.selected.name;
				loadDetail(data.selected.reference);
			}
			
			protected function loadDetail(reference:String):void {
				var url:String = "https://maps.googleapis.com/maps/api/place/details/json?";
				url += "reference="+reference + "&key=" + apiKey + "&sensor=true";
				httpService.url = url;
				var async:AsyncToken = httpService.send();
				async.resultHandler = placeResult;
				async.faultHandler = faultResult;			
			}
			
			private function placeResult(event:ResultEvent):void {
				var resultData:Object = JSON.decode(event.result.toString());
				addressLabel.text = resultData.result.formatted_address;
				phoneLabel.text = resultData.result.formatted_phone_number;
				trace(mapImage.width+","+mapImage.height);
				//figure out which is bigger and use that so we don't get squishies
				/*
				if(mapImage.width > mapImage.height) mapImage.width = mapImage.height;
				else if(mapImage.height > mapImage.width) mapImage.height = mapImage.width;
				*/
				trace(mapImage.width+","+mapImage.height);
				mapImage.source = new URLRequest("http://maps.google.com/maps/api/staticmap?center=" + resultData.result.geometry.location.lat + "," + 
					resultData.result.geometry.location.lng + "&zoom=15&size="+mapImage.width+"x"+mapImage.height+"&maptype=roadmap" +
					"&markers=color:red%7C" + resultData.result.geometry.location.lat + "," + resultData.result.geometry.location.lng +
					"&sensor=false");				
				trace("done ");	
			}
			
			private function faultResult(event:FaultEvent):void {
				trace("fault");
				//statusLabel.text = "Sorry, we were unable to connect.";
			}
			
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<s:HTTPService id="httpService" result="event.token.resultHandler(event)" fault="event.token.faultHandler(event)" />
	</fx:Declarations>
	
	<s:actionContent>
		<s:Button label="Back" click="goBack(event)" />		
	</s:actionContent>
	
	<s:layout>
		<s:VerticalLayout horizontalAlign="left" verticalAlign="top" paddingTop="5" paddingLeft="5" paddingRight="5" gap="5"/>
	</s:layout>
	
	<s:HGroup width="100%">		
		<s:Label text="Address: " />
		<s:RichText id="addressLabel" width="100%"  />
	</s:HGroup>
	
	<s:HGroup>		
		<s:Label text="Phone: " />
		<s:RichText id="phoneLabel" click="navigateToURL(new URLRequest('tel:'+phoneLabel.text))" /> 
	</s:HGroup>
	
	<s:Image id="mapImage" width="100%" height="100%" />
	
</s:View>
